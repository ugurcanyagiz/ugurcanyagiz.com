/**
 * HomeCarousel.astro
 * Fixes:
 * - Prevents horizontal overflow on small phones
 * - Keeps slide background stable (no "image drifting")
 * - Uses modern mobile viewport units (svh) to avoid address-bar jump
 */
const slides = [
  {
    href: "/blog",
    title: "JLOG",
    kicker: "Journal · Writing",
    subtitle: "Short notes, clear thinking. Minimal and timeless.",
    cta: "Open JLOG →",
    img: "https://images.unsplash.com/photo-1455390582262-044cdead277a?w=2400&q=85",
  },
  {
    href: "/science",
    title: "SCIENCE",
    kicker: "Cosmos · Physics · Mind",
    subtitle: "Explaining complex things simply. Evidence, models, and the edge of what we know.",
    cta: "Explore Science →",
    img: "https://images.unsplash.com/photo-1636466497217-26a8cbeaf0aa?w=2400&q=85",
  },
  {
    href: "/history",
    title: "HISTORY",
    kicker: "Civilizations · Patterns",
    subtitle: "Big patterns: people, incentives, rise & fall. What repeats, what breaks, what matters.",
    cta: "Explore History →",
    img: "https://images.unsplash.com/photo-1461360228754-6e81c478b882?w=2400&q=85",
  },
  {
    href: "/art",
    title: "ART",
    kicker: "Design · Music · Craft",
    subtitle: "Taste, composition, and the craft behind creative decisions — from sketches to systems.",
    cta: "Explore Art →",
    img: "https://images.unsplash.com/photo-1460661419201-fd4cecdf8a8b?w=2400&q=85",
  },
  {
    href: "/future",
    title: "FUTURE",
    kicker: "AI · Systems · Tomorrow",
    subtitle: "Signals, trajectories, and thoughtful speculation — grounded optimism, clear risks.",
    cta: "Explore Future →",
    img: "https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=2400&q=85",
  },
];
---

<section class="stage" aria-label="Home navigation">
  <div class="carousel">
    <div class="viewport" id="viewport" aria-roledescription="carousel">
      <div class="track" id="track">
        {slides.map((s) => (
          <a
            class="slide"
            href={s.href}
            style={`--img:url('${s.img}')`}
            data-title={s.title}
          >
            <div class="slide-content" data-anim>
              <div class="kicker">{s.kicker}</div>
              <div class="title">{s.title}</div>
              <p class="subtitle">{s.subtitle}</p>
              <span class="cta">{s.cta}</span>
            </div>
          </a>
        ))}
      </div>

      <div class="controls" aria-hidden="false">
        <button class="arrow" id="prev" aria-label="Previous">‹</button>
        <button class="arrow" id="next" aria-label="Next">›</button>
      </div>
    </div>

    <div class="dots" id="dots" aria-label="Carousel position"></div>
  </div>
</section>

<style>
  :root{
    --panel:#ffffff;
    --text:#0b0b0f;
    --line:rgba(11,11,15,.10);
    --radius:22px;
    --shadow:0 22px 70px rgba(0,0,0,.10);
    --container:1100px;
  }

  .stage{
    max-width:var(--container);
    margin:0 auto;
    padding: 18px var(--pad, 24px) 28px;
  }

  .carousel{ position:relative; }

  .viewport{
    position:relative;
    width:100%;
    overflow:hidden;
    border-radius:var(--radius);
    background:var(--panel);
    border:1px solid var(--line);
    box-shadow:var(--shadow);

    /* Desktop default */
    height: min(74svh, 660px);
    min-height: 460px;
    max-height: 720px;

    /* iOS/Safari overflow + transform fixes */
    clip-path: inset(0 round var(--radius));
    -webkit-mask-image: -webkit-radial-gradient(white, black);
    transform: translateZ(0);
    isolation:isolate;
  }

  .track{
    height:100%;
    display:flex;
    width:100%;
    gap:0;
    transition:transform .55s cubic-bezier(.2,.8,.2,1);
    will-change:transform;
    transform: translate3d(0,0,0);
  }

  .slide{
    width:100%;
    min-width:100%;
    flex:0 0 100%;
    position:relative;
    display:flex;
    align-items:flex-end;
    justify-content:flex-start;
    padding: clamp(18px, 3vw, 28px);
    color:#fff;
    overflow:hidden;
    user-select:none;
    -webkit-user-select:none;
    touch-action:pan-y;
  }

  /* Stable background (prevents subtle "drifting" on scroll/translate) */
  .slide::before{
    content:"";
    position:absolute; inset:0;
    background-image:var(--img);
    background-size:cover;
    background-position:center;
    transform: translate3d(0,0,0) scale(1.03);
    transform-origin:center;
    will-change: transform;
    backface-visibility:hidden;
  }

  /* Calmer overlay (less heavy) */
  .slide::after{
    content:"";
    position:absolute; inset:0;
    background: linear-gradient(180deg,
      rgba(0,0,0,.06) 0%,
      rgba(0,0,0,.16) 42%,
      rgba(0,0,0,.66) 100%
    );
  }

  .slide-content{
    position:relative;
    z-index:2;
    max-width: 680px;
  }

  .kicker{
    display:inline-flex;
    align-items:center;
    padding:8px 12px;
    border-radius:999px;
    background:rgba(255,255,255,.14);
    border:1px solid rgba(255,255,255,.20);
    backdrop-filter:blur(10px);
    font-size:12px;
    letter-spacing:.14em;
    text-transform:uppercase;
    font-weight:700;
  }

  .title{
    margin: 14px 0 10px;
    font-size: clamp(34px, 6vw, 62px);
    line-height:1.02;
    letter-spacing:-0.06em;
    font-weight:750;
  }

  .subtitle{
    margin:0;
    color:rgba(255,255,255,.86);
    font-size:15px;
    line-height:1.55;
    max-width:52ch;
    overflow-wrap:anywhere;
  }

  .cta{
    margin-top:18px;
    display:inline-flex;
    align-items:center;
    gap:10px;
    padding:12px 14px;
    border-radius:999px;
    background:rgba(255,255,255,.92);
    color:var(--text);
    font-weight:700;
    font-size:13px;
    white-space:nowrap;
  }

  .controls{
    position:absolute;
    inset:0;
    pointer-events:none;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 10px;
    z-index:5;
  }

  .arrow{
    pointer-events:auto;
    width:44px;height:44px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.22);
    background:rgba(0,0,0,.28);
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    backdrop-filter:blur(10px);
    transition:transform .18s ease, background .18s ease;
  }
  .arrow:hover{background:rgba(0,0,0,.40)}
  .arrow:active{transform:scale(.98)}

  .dots{
    margin-top:14px;
    display:flex;
    justify-content:center;
    gap:8px;
  }
  .dot{
    width:7px;height:7px;
    border-radius:999px;
    background:rgba(0,0,0,.22);
    border:1px solid rgba(0,0,0,.10);
    transition: transform .2s ease, background .2s ease;
  }
  .dot.active{background:rgba(0,0,0,.78); transform: scale(1.2);}

  /* Micro animations */
  .viewport.pulse [data-anim]{
    animation: microPulse .34s ease-out both;
  }
  @keyframes microPulse{
    0%{ transform: translateY(0); filter: none; }
    45%{ transform: translateY(-2px); filter: drop-shadow(0 10px 22px rgba(0,0,0,.18)); }
    100%{ transform: translateY(0); filter: none; }
  }

  /* Mobile: fit nicely without clipping or horizontal overflow */
  @media (max-width: 720px){
    .stage{ padding: 14px var(--pad, 24px) 18px; }

    .viewport{
      /* svh handles iOS address bar better than vh */
      height: calc(100svh - 170px);
      min-height: 420px;
      max-height: 560px;
    }

    .slide{ padding: 18px; }
    .arrow{ width:42px; height:42px; }

    .subtitle{ font-size: 14px; }
  }

  /* Very small phones */
  @media (max-width: 380px){
    .viewport{ min-height: 390px; }
    .title{ font-size: 34px; }
    .kicker{ font-size: 11px; }
  }

  @media (prefers-reduced-motion: reduce){
    .track{transition:none}
    .viewport.pulse [data-anim]{animation:none}
  }
</style>

<script>
  const track = document.getElementById('track');
  const viewport = document.getElementById('viewport');
  const slides = Array.from(document.querySelectorAll('.slide'));
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const dotsWrap = document.getElementById('dots');

  let index = 0;
  let startX = 0;
  let startY = 0;
  let dragging = false;

  // dots
  const dots = slides.map((_, i) => {
    const d = document.createElement('div');
    d.className = 'dot' + (i === 0 ? ' active' : '');
    d.addEventListener('click', () => go(i));
    dotsWrap.appendChild(d);
    return d;
  });

  function setPulse(){
    viewport.classList.remove('pulse');
    void viewport.offsetWidth; // restart animation
    viewport.classList.add('pulse');
    window.setTimeout(() => viewport.classList.remove('pulse'), 380);
  }

  function update(){
    const tx = -index * 100;
    track.style.transform = `translate3d(${tx}%, 0, 0)`;
    dots.forEach((d,i) => d.classList.toggle('active', i === index));
    setPulse();
  }

  function go(i){
    index = (i + slides.length) % slides.length;
    update();
  }

  prevBtn.addEventListener('click', () => go(index - 1));
  nextBtn.addEventListener('click', () => go(index + 1));

  // Keyboard arrows (desktop)
  window.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') go(index - 1);
    if (e.key === 'ArrowRight') go(index + 1);
  });

  // Touch swipe (mobile)
  function onStart(e){
    const p = e.touches ? e.touches[0] : e;
    dragging = true;
    startX = p.clientX;
    startY = p.clientY;
  }

  function onEnd(e){
    if (!dragging) return;
    dragging = false;
    const p = e.changedTouches ? e.changedTouches[0] : e;
    const dx = p.clientX - startX;
    const dy = p.clientY - startY;

    if (Math.abs(dx) > 45 && Math.abs(dx) > Math.abs(dy)){
      if (dx < 0) go(index + 1);
      else go(index - 1);
    }
  }

  viewport.addEventListener('touchstart', onStart, {passive:true});
  viewport.addEventListener('touchend', onEnd, {passive:true});

  // Optional mouse drag (desktop)
  viewport.addEventListener('mousedown', onStart);
  window.addEventListener('mouseup', onEnd);

  // Prevent accidental drag
  viewport.addEventListener('dragstart', (e) => e.preventDefault());

  update();
</script>
